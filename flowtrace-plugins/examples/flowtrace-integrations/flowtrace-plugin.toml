# Flowtrace Integrations Bundle
# This plugin bundles integrations for Claude Code, Cursor, and other AI editors/agents.
# Version 2 manifest with bundle configuration.

schema_version = 2

[plugin]
id = "flowtrace-integrations"
name = "Flowtrace Integrations"
version = "0.1.0"
description = "Bundle of Flowtrace integrations for Claude Code, Cursor, and other AI coding assistants"
authors = ["Flowtrace Contributors"]
license = "Apache-2.0"
repository = "https://github.com/sochdb/flowtrace"
homepage = "https://flowtrace.dev"
type = "bundle"
min_flowtrace_version = "0.5.0"
tags = ["integration", "claude", "cursor", "mcp", "observability"]
icon = "icons/integrations.svg"

# Bundle configuration
[bundle]
bundle_version = "1.0.0"
default_install_mode = "guided"  # Options: guided, auto, manual
assets_root = "integrations"

# User variables that may be prompted during installation
[[bundle.variables]]
name = "project_dir"
label = "Project Directory"
kind = "directory"
required = false
description = "Optional project directory for project-scoped installation"

# ============================================================================
# Claude Code Target
# ============================================================================
[[bundle.targets]]
id = "claude_code"
display_name = "Claude Code"
kind = "claude_plugin"
install_md = "claude/install.md"
scopes = ["user", "project"]
default_scope = "user"

# Detection: Check if Claude Code is installed
[[bundle.targets.detect]]
type = "file_exists"
path = "${home}/.claude/settings.json"

# Detection: Check if Claude CLI is available
[[bundle.targets.detect]]
type = "command_exists"
command = "claude"

# Files to copy for Claude Code integration
[[bundle.targets.files_to_copy]]
from = "claude/plugin"
to = "${home}/.claude/plugins/flowtrace"
strategy = "copy_dir"
overwrite = true
description = "Copy Flowtrace plugin files to Claude plugins directory"

# Install operation: Register plugin in Claude's settings.json
[[bundle.targets.ops]]
type = "json_merge"
file = "${home}/.claude/settings.json"
description = "Enable Flowtrace plugin in Claude settings"
create_parents = true
[bundle.targets.ops.object]
[bundle.targets.ops.object.enabledPlugins]
"flowtrace" = true

# Install operation: Add Flowtrace marketplace
[[bundle.targets.ops]]
type = "json_merge"
file = "${home}/.claude/settings.json"
description = "Register Flowtrace marketplace source"
[bundle.targets.ops.object]
[bundle.targets.ops.object.extraKnownMarketplaces]
[bundle.targets.ops.object.extraKnownMarketplaces.flowtrace]
[bundle.targets.ops.object.extraKnownMarketplaces.flowtrace.source]
source = "local"
path = "${home}/.claude/plugins/flowtrace"

# Alternative: Use npm source (if published)
# [[bundle.targets.ops]]
# type = "json_merge"
# file = "${home}/.claude/settings.json"
# [bundle.targets.ops.object.extraKnownMarketplaces.sochdb.source]
# source = "npm"
# package = "@sochdb/flowtrace-claude-code"

# Commands for manual verification
[[bundle.targets.commands]]
label = "Verify Claude plugin"
command = "claude plugins list | grep flowtrace"
shell = true
auto_run = false

[[bundle.targets.commands]]
label = "Restart Claude Code"
command = "echo 'Please restart Claude Code to activate the plugin'"
shell = true
auto_run = true

# ============================================================================
# Cursor Target (MCP Server)
# ============================================================================
[[bundle.targets]]
id = "cursor"
display_name = "Cursor (MCP)"
kind = "cursor_mcp"
install_md = "cursor/install.md"
scopes = ["user", "project"]
default_scope = "user"

# Detection: Check for user-level mcp.json
[[bundle.targets.detect]]
type = "file_exists"
path = "${home}/.cursor/mcp.json"

# Detection: Check for project-level mcp.json (only if project_dir is set)
[[bundle.targets.detect]]
type = "file_exists"
path = "${project_dir}/.cursor/mcp.json"
[bundle.targets.detect.when]
var = "project_dir"
is_set = true

# Install operation: Add Flowtrace MCP server to user config
[[bundle.targets.ops]]
type = "json_patch"
file_candidates = ["${home}/.cursor/mcp.json"]
description = "Register Flowtrace MCP server in Cursor"
create_if_missing = true
[bundle.targets.ops.initial_content]
mcpServers = {}

[[bundle.targets.ops.patch]]
op = "add"
path = "/mcpServers/flowtrace"
[bundle.targets.ops.patch.value]
command = "flowtrace-mcp"
args = ["--stdio"]

# Alternative: Project-scoped installation
# [[bundle.targets.ops]]
# type = "json_patch"
# file_candidates = ["${project_dir}/.cursor/mcp.json", "${home}/.cursor/mcp.json"]
# create_if_missing = true
# [[bundle.targets.ops.patch]]
# op = "add"
# path = "/mcpServers/flowtrace"
# [bundle.targets.ops.patch.value]
# command = "npx"
# args = ["-y", "@sochdb/flowtrace-mcp"]

# Commands
[[bundle.targets.commands]]
label = "Verify Cursor MCP config"
command = "cat ${home}/.cursor/mcp.json | grep flowtrace"
shell = true
auto_run = false

[[bundle.targets.commands]]
label = "Reload Cursor"
command = "echo 'Please reload Cursor window to activate MCP server'"
shell = true
auto_run = true

# ============================================================================
# VS Code Target (future)
# ============================================================================
[[bundle.targets]]
id = "vscode"
display_name = "VS Code"
kind = "vscode_extension"
install_md = "vscode/install.md"
scopes = ["user"]
default_scope = "user"

# Detection: Check for VS Code
[[bundle.targets.detect]]
type = "command_exists"
command = "code"

# Commands to install extension
[[bundle.targets.commands]]
label = "Install Flowtrace extension"
command = "code --install-extension flowtrace.flowtrace-vscode"
shell = true
auto_run = false
confirm = "This will install the Flowtrace VS Code extension. Continue?"

# ============================================================================
# Windsurf Target (similar to Cursor)
# ============================================================================
[[bundle.targets]]
id = "windsurf"
display_name = "Windsurf"
kind = "cursor_mcp"
install_md = "windsurf/install.md"
scopes = ["user", "project"]
default_scope = "user"

# Detection
[[bundle.targets.detect]]
type = "file_exists"
path = "${home}/.windsurf/mcp.json"

# MCP registration
[[bundle.targets.ops]]
type = "json_patch"
file_candidates = ["${home}/.windsurf/mcp.json"]
description = "Register Flowtrace MCP server in Windsurf"
create_if_missing = true
[bundle.targets.ops.initial_content]
mcpServers = {}

[[bundle.targets.ops.patch]]
op = "add"
path = "/mcpServers/flowtrace"
[bundle.targets.ops.patch.value]
command = "flowtrace-mcp"
args = ["--stdio"]
