// Flowtrace Plugin Interface Definition
// 
// This WIT (WASM Interface Types) file defines the universal plugin interface
// that all Flowtrace plugins must implement, regardless of source language.
//
// Plugins can be written in Rust, Python, TypeScript, Go, or any language
// that compiles to WASM and supports the Component Model.

package flowtrace:plugin@0.1.0;

/// Core types shared across all plugin interfaces
interface types {
    /// Unique identifier (128-bit UUID as two u64s)
    record trace-id {
        high: u64,
        low: u64,
    }

    /// Span types in a trace
    enum span-type {
        llm-call,
        tool-call,
        retrieval,
        agent-step,
        embedding,
        custom,
    }

    /// A single span/edge in a trace
    record span {
        id: trace-id,
        parent-id: option<trace-id>,
        span-type: span-type,
        name: string,
        input: option<string>,
        output: option<string>,
        model: option<string>,
        timestamp-us: u64,
        duration-us: option<u64>,
        token-count: option<u32>,
        cost-usd: option<f64>,
        metadata: list<tuple<string, string>>,
    }

    /// Complete trace context for evaluation
    record trace-context {
        trace-id: trace-id,
        spans: list<span>,
        input: option<string>,
        output: option<string>,
        metadata: list<tuple<string, string>>,
    }

    /// Metric value (union type)
    variant metric-value {
        float-val(f64),
        int-val(s64),
        bool-val(bool),
        string-val(string),
    }

    /// Evaluation result
    record eval-result {
        evaluator-id: string,
        passed: bool,
        confidence: f64,
        explanation: option<string>,
        metrics: list<tuple<string, metric-value>>,
        cost-usd: option<f64>,
        duration-ms: option<u32>,
    }

    /// Plugin metadata
    record plugin-metadata {
        id: string,
        name: string,
        version: string,
        description: string,
        author: option<string>,
        tags: list<string>,
        cost-per-eval: option<f64>,
    }

    /// Embedding vector
    type embedding = list<f32>;

    /// Log levels
    enum log-level {
        trace,
        debug,
        info,
        warn,
        error,
    }

    /// HTTP response from host
    record http-response {
        status: u16,
        headers: list<tuple<string, string>>,
        body: list<u8>,
    }

    /// Plugin configuration entry
    record config-entry {
        key: string,
        value: string,
        description: option<string>,
        required: bool,
    }

    /// Plugin capability request
    enum capability {
        trace-read,
        trace-write,
        eval-write,
        network,
        env-vars,
        fs-read,
        fs-write,
        embedding,
    }
}

/// Host functions provided by Flowtrace to plugins
interface host {
    use types.{trace-id, trace-context, log-level, embedding, http-response};

    /// Query traces from the database
    query-traces: func(
        filter-json: string,
        limit: u32
    ) -> result<list<trace-context>, string>;

    /// Get a single trace by ID
    get-trace: func(id: trace-id) -> result<option<trace-context>, string>;

    /// Log a message
    log: func(level: log-level, message: string);

    /// Get plugin configuration (JSON)
    get-config: func() -> string;

    /// Get specific configuration value
    get-config-value: func(key: string) -> option<string>;

    /// Make HTTP request (requires network capability)
    http-request: func(
        method: string,
        url: string,
        headers: list<tuple<string, string>>,
        body: option<list<u8>>
    ) -> result<http-response, string>;

    /// Generate embeddings using host provider (requires embedding capability)
    embed-text: func(text: string) -> result<embedding, string>;
    
    /// Batch embed texts
    embed-batch: func(texts: list<string>) -> result<list<embedding>, string>;

    /// Get environment variable (requires env-vars capability)
    get-env: func(name: string) -> option<string>;

    /// Read file (requires fs-read capability)
    read-file: func(path: string) -> result<list<u8>, string>;

    /// Write file (requires fs-write capability)
    write-file: func(path: string, contents: list<u8>) -> result<_, string>;
}

/// Evaluator plugin interface
interface evaluator {
    use types.{trace-context, eval-result, plugin-metadata};

    /// Evaluate a trace
    evaluate: func(trace: trace-context) -> result<eval-result, string>;

    /// Get plugin metadata
    get-metadata: func() -> plugin-metadata;

    /// Optional: batch evaluation for efficiency
    evaluate-batch: func(traces: list<trace-context>) -> result<list<eval-result>, string>;

    /// Optional: get configuration schema (JSON Schema)
    get-config-schema: func() -> option<string>;
}

/// Embedding provider plugin interface  
interface embedding-provider {
    use types.{embedding, plugin-metadata};

    /// Embed single text
    embed: func(text: string) -> result<embedding, string>;

    /// Batch embed for efficiency
    embed-batch: func(texts: list<string>) -> result<list<embedding>, string>;

    /// Get embedding dimension
    dimension: func() -> u32;

    /// Get max tokens supported
    max-tokens: func() -> u32;

    /// Get plugin metadata
    get-metadata: func() -> plugin-metadata;
}

/// Data exporter plugin interface
interface exporter {
    use types.{trace-context, plugin-metadata};

    /// Export traces to external format
    export: func(
        traces: list<trace-context>,
        format: string,
        options: string
    ) -> result<list<u8>, string>;

    /// Get supported export formats
    supported-formats: func() -> list<string>;

    /// Get plugin metadata
    get-metadata: func() -> plugin-metadata;
}

/// Data transformer plugin interface
interface transformer {
    use types.{trace-context, plugin-metadata};

    /// Transform traces
    transform: func(
        traces: list<trace-context>,
        options: string
    ) -> result<list<trace-context>, string>;

    /// Get plugin metadata
    get-metadata: func() -> plugin-metadata;
}

/// Main plugin world - plugins implement one or more interfaces
world flowtrace-plugin {
    /// Import host functions
    import host;
    
    /// Export one or more plugin interfaces
    export evaluator;
}

/// Embedding provider world
world flowtrace-embedding-provider {
    import host;
    export embedding-provider;
}

/// Exporter world
world flowtrace-exporter {
    import host;
    export exporter;
}

/// Transformer world  
world flowtrace-transformer {
    import host;
    export transformer;
}
