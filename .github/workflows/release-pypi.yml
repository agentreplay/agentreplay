# Copyright 2025 Sushanth (https://github.com/sushanthpy)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# ============================================================================
# Publish Python SDK to PyPI
# ============================================================================
#
# This workflow builds and publishes the agentreplay Python SDK to PyPI.
#
# Trigger:
#   - Manual workflow dispatch (workflow_dispatch)
#   - On release creation (for automatic publishing)
#
# Prerequisites:
#   1. Package name 'agentreplay' must be registered on PyPI
#   2. Configure Trusted Publisher on PyPI:
#      - Go to: https://pypi.org/manage/project/agentreplay/settings/publishing/
#      - Add new publisher:
#        - Owner: agentreplay
#        - Repository: agentreplay
#        - Workflow: release-pypi.yml
#        - Environment: (leave empty for "Any environment")
#
# Usage:
#   - Manual: Actions -> Release Python SDK to PyPI -> Run workflow
#   - Automatic: Create a new release with tag matching v*
#
# ============================================================================

name: Release Python SDK to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (leave empty to use pyproject.toml version)'
        required: false
        type: string
      publish_to_testpypi:
        description: 'Publish to TestPyPI first (for testing)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================
  # Build the Python package
  # ============================================
  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Update version (if specified)
        if: ${{ inputs.version != '' }}
        working-directory: sdks/python
        run: |
          echo "Updating version to ${{ inputs.version }}"
          sed -i "s/version = \".*\"/version = \"${{ inputs.version }}\"/" pyproject.toml
          # Also update __init__.py version
          sed -i "s/__version__ = \".*\"/__version__ = \"${{ inputs.version }}\"/" src/agentreplay/__init__.py
          echo "Updated pyproject.toml:"
          grep "version" pyproject.toml | head -1

      - name: Validate package metadata
        working-directory: sdks/python
        run: |
          echo "=== Package Info ==="
          grep -E "^name|^version|^description" pyproject.toml | head -5
          echo ""
          echo "=== Checking README.md exists ==="
          ls -la README.md
          echo ""
          echo "=== Checking src structure ==="
          ls -la src/agentreplay/

      - name: Build source distribution and wheel
        working-directory: sdks/python
        run: |
          python -m build
          echo ""
          echo "=== Built artifacts ==="
          ls -la dist/

      - name: Check package with twine
        working-directory: sdks/python
        run: |
          twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: sdks/python/dist/
          retention-days: 5

  # ============================================
  # Publish to TestPyPI (optional)
  # ============================================
  publish-testpypi:
    name: Publish to TestPyPI
    needs: build
    if: ${{ inputs.publish_to_testpypi == true }}
    runs-on: ubuntu-latest
    environment:
      name: testpypi
      url: https://test.pypi.org/p/agentreplay

    permissions:
      id-token: write  # Required for trusted publishing

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: List distribution files
        run: ls -la dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          print-hash: true
          verbose: true

  # ============================================
  # Publish to PyPI (production)
  # ============================================
  publish-pypi:
    name: Publish to PyPI
    needs: build
    # Skip if only publishing to TestPyPI
    if: ${{ inputs.publish_to_testpypi != true }}
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/agentreplay

    permissions:
      id-token: write  # Required for trusted publishing

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: List distribution files
        run: |
          echo "=== Distribution files ==="
          ls -la dist/
          echo ""
          echo "=== File hashes ==="
          sha256sum dist/*

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          print-hash: true
          verbose: true

  # ============================================
  # Verify installation after publish
  # ============================================
  verify:
    name: Verify Installation
    needs: publish-pypi
    if: ${{ inputs.publish_to_testpypi != true }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Wait for PyPI to update
        run: sleep 60

      - name: Install from PyPI
        run: |
          pip install agentreplay
          python -c "import agentreplay; print(f'Successfully installed agentreplay v{agentreplay.__version__}')"

      - name: Test basic import
        run: |
          python -c "
          from agentreplay import AgentreplayClient, SpanType, AgentreplayConfig
          from agentreplay import auto_instrument, setup_instrumentation
          from agentreplay import Session, BatchingAgentreplayClient
          print('All imports successful!')
          "
